{% extends "dashboard/farmer/base_farmer.html" %} {% block dashboard_content %}

<div class="w-full mx-auto bg-white rounded-2xl shadow p-8">
  <!-- Upload Header -->
  <div class="border-b border-green-200 pb-6 mb-6">
    <h2 class="text-2xl font-bold text-green-800 mb-2 flex items-center gap-2">
      <span>🔬</span> Analyze Plant Image
    </h2>
    <p class="text-green-700">
      Upload a photo of your plant to get AI-powered disease detection and
      expert recommendations.
    </p>
  </div>

  <!-- Main Content Layout -->
  <div class="space-y-6">
    <!-- Top Row: Upload (left) + Open Case Form (right) -->
    <div class="flex gap-6">
      <!-- Left Container: Image Upload/Preview -->
      <div class="w-1/2">
        <div
          class="bg-green-50 rounded-lg p-4 border border-green-200 min-h-96"
        >
          <h3
            class="text-lg font-semibold text-green-800 mb-4 flex items-center gap-2"
          >
            <span>📷</span> Image Upload
          </h3>

          <form
            method="POST"
            enctype="multipart/form-data"
            class="flex flex-col space-y-4"
          >
            {% csrf_token %}
            <div class="flex-1 flex flex-col items-center justify-center">
              <div
                class="w-56 h-56 border-2 border-dashed border-green-300 rounded-lg p-4 text-center hover:border-green-400 transition flex flex-col items-center justify-center"
                id="uploadArea"
              >
                <input
                  type="file"
                  name="plant_image"
                  accept="image/*"
                  required
                  class="hidden"
                  id="imageInput"
                />
                <label for="imageInput" class="cursor-pointer">
                  <span class="text-3xl mb-2 block">📷</span>
                  <span class="text-green-700 font-medium text-sm"
                    >Click to upload image</span
                  >
                  <p class="text-xs text-green-600 mt-1">
                    JPG, PNG, or GIF up to 10MB
                  </p>
                </label>
              </div>

              <!-- Image Preview -->
              <div id="imagePreview" class="hidden mt-4">
                <div class="text-center">
                  <h4
                    class="text-sm font-medium text-green-800 mb-2 flex items-center gap-2 justify-center"
                  >
                    <span>🖼️</span> Image Preview
                  </h4>
                  <div class="flex items-center justify-center">
                    <div
                      class="w-56 h-56 bg-white rounded-lg shadow-md border border-green-200 flex items-center justify-center overflow-hidden"
                    >
                      <img
                        id="previewImg"
                        src=""
                        alt="Plant Image Preview"
                        class="w-full h-full object-contain"
                      />
                    </div>
                  </div>
                  <div class="mt-2 flex items-center justify-between">
                    <span
                      id="fileName"
                      class="text-xs text-green-700 font-medium"
                    ></span>
                    <button
                      type="button"
                      onclick="removeImage()"
                      class="text-red-600 hover:text-red-800 text-xs font-medium flex items-center gap-1"
                    >
                      <span>🗑️</span> Remove
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="flex justify-center">
              <button
                type="submit"
                class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium flex items-center gap-2"
              >
                <span>🔍</span> Analyze Image
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Right Container: Open Case Form -->
      <div class="w-1/2">
        {% if result %}
        <div
          class="bg-blue-50 rounded-lg p-6 border border-blue-200 h-96 overflow-y-auto"
        >
          <h3
            class="text-lg font-bold text-blue-800 mb-4 flex items-center gap-2"
          >
            <span>📋</span> Open Case for Doctor Review
          </h3>
          <p class="text-blue-700 mb-4 text-sm">
            If you need additional assistance or have specific questions about
            the analysis, you can open a case for doctors to review and provide
            personalized recommendations.
          </p>

          <form
            method="POST"
            action="{% url 'farmer_open_case' %}"
            class="space-y-4"
          >
            {% csrf_token %}
            <input
              type="hidden"
              name="analysis_id"
              value="{{ result.analysis_id|default:'' }}"
            />
            <input
              type="hidden"
              name="disease_name"
              value="{{ result.disease_name|default:'' }}"
            />
            <input
              type="hidden"
              name="crop_name"
              value="{{ result.crop_name|default:'' }}"
            />

            <div>
              <label class="block text-sm font-medium text-blue-700 mb-2"
                >Additional Notes</label
              >
              <textarea
                name="case_notes"
                rows="3"
                class="w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 resize-none"
                placeholder="Describe your specific concerns, symptoms you've noticed, or any additional info..."
                required
              ></textarea>
            </div>

            <div class="flex justify-end">
              <button
                type="submit"
                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium flex items-center gap-2"
              >
                <span>📝</span> Submit Case
              </button>
            </div>
          </form>
        </div>
        {% else %}
        <div
          class="bg-blue-50 rounded-lg p-6 border border-blue-200 h-96 flex items-center justify-center text-center"
        >
          <div class="text-blue-600">
            <span class="text-4xl block mb-3">📋</span>
            <p class="text-base font-medium">
              Open Case option will be available after analysis
            </p>
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Bottom Container: Analysis Results -->
    <div class="bg-green-50 rounded-lg p-6 border border-green-200 mt-6">
      <h3
        class="text-lg font-semibold text-green-800 mb-4 flex items-center gap-2"
      >
        <span>📊</span> Analysis Results
      </h3>

      {% if result %}
      <!-- Disease Info -->
      <div class="bg-white rounded-lg p-4 mb-4 border border-green-200 text-sm">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <span class="font-semibold text-green-800">Crop:</span>
            <span class="text-green-700 ml-1">{{ result.crop_name }}</span>
          </div>
          <div>
            <span class="font-semibold text-green-800">Disease:</span>
            <span class="text-green-700 ml-1">{{ result.disease_name }}</span>
          </div>
          <div>
            <span class="font-semibold text-green-800">Confidence:</span>
            <span class="text-green-700 ml-1"
              >{{ result.confidence|floatformat:0 }}%</span
            >
          </div>
          <div>
            <span class="font-semibold text-green-800">Date:</span>
            <span class="text-green-700 ml-1">{{ result.analysis_date }}</span>
          </div>
        </div>
      </div>

      {% if result.suggestions %}
      <div class="space-y-3">
        <h4
          class="text-base font-bold text-green-800 mb-2 flex items-center gap-2"
        >
          <span>💡</span> Expert Recommendations
        </h4>
        {% for suggestion in result.suggestions %}
        <div
          class="bg-white border border-green-200 rounded-lg p-3 shadow-sm text-sm"
        >
          <div class="border-b border-green-200 pb-2 mb-2">
            <h5 class="text-sm font-bold text-green-800 mb-1">
              {{ suggestion.title }}
            </h5>
            <div class="flex items-center justify-between">
              <span class="text-xs text-green-600"
                >By {{ suggestion.suggested_by }}</span
              >
              <span
                class="px-2 py-0.5 rounded-full text-xs font-medium {% if suggestion.priority == 'high' %}bg-red-100 text-red-800 {% elif suggestion.priority == 'medium' %}bg-yellow-100 text-yellow-800 {% else %}bg-green-100 text-green-800{% endif %}"
              >
                {{ suggestion.priority|title }} Priority
              </span>
            </div>
          </div>
          <div class="mb-2">
            <h6
              class="uppercase text-xs font-semibold text-green-700 mb-1 tracking-wide flex items-center gap-1"
            >
              <span>💊</span> Treatment
            </h6>
            <p class="text-green-700 bg-green-50 rounded p-2 text-xs">
              {{ suggestion.treatment }}
            </p>
          </div>
          <div class="mb-2">
            <h6
              class="uppercase text-xs font-semibold text-green-700 mb-1 tracking-wide flex items-center gap-1"
            >
              <span>🛡️</span> Prevention
            </h6>
            <p class="text-green-700 bg-green-50 rounded p-2 text-xs">
              {{ suggestion.prevention }}
            </p>
          </div>
          {% if suggestion.best_practices %}
          <div>
            <h6
              class="uppercase text-xs font-semibold text-green-700 mb-1 tracking-wide flex items-center gap-1"
            >
              <span>✅</span> Best Practices
            </h6>
            <p class="text-green-700 bg-green-50 rounded p-2 text-xs">
              {{ suggestion.best_practices }}
            </p>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      {% endif %} {% else %}
      <div class="h-full flex items-center justify-center">
        <div class="text-center text-green-600">
          <span class="text-4xl block mb-3">🔬</span>
          <p class="text-base font-medium">Upload an image to start analysis</p>
          <p class="text-sm">Results will appear here after analysis</p>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  document
    .getElementById("imageInput")
    .addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const previewImg = document.getElementById("previewImg");
          const fileName = document.getElementById("fileName");
          const imagePreview = document.getElementById("imagePreview");
          const uploadArea = document.getElementById("uploadArea");

          previewImg.src = e.target.result;
          fileName.textContent = file.name;
          imagePreview.classList.remove("hidden");
          uploadArea.classList.add("hidden");
        };
        reader.readAsDataURL(file);
      }
    });

  function removeImage() {
    const imageInput = document.getElementById("imageInput");
    const imagePreview = document.getElementById("imagePreview");
    const uploadArea = document.getElementById("uploadArea");

    imageInput.value = "";
    imagePreview.classList.add("hidden");
    uploadArea.classList.remove("hidden");
  }
</script>

{% endblock %}
