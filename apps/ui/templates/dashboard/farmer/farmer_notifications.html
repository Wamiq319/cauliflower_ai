{% extends "dashboard/farmer/base_farmer.html" %} {% block dashboard_content %}

<!-- Header -->
<div class="flex flex-col items-center mb-6">
  <span class="text-5xl mb-2">üîî</span>
  <h1 class="text-2xl font-extrabold text-green-800 mb-2">Notifications</h1>
  <p class="text-md text-green-700 text-center">
    Review all notifications sent to you by the admin.
  </p>
</div>

<!-- Notifications Table Card -->
<div class="bg-white rounded-2xl shadow p-6">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-lg font-bold text-green-800 flex items-center gap-2">
      <span>üìã</span> All Notifications
    </h2>
  </div>

  <div class="overflow-x-auto">
    <table
      class="min-w-full border border-green-200 rounded-lg text-sm relative"
    >
      <thead class="bg-green-50 text-green-800">
        <tr>
          <th class="px-4 py-2 border">#ID</th>
          <th class="px-4 py-2 border">Title</th>
          <th class="px-4 py-2 border">Message</th>
          <th class="px-4 py-2 border">Date</th>
          <th class="px-4 py-2 border">Status</th>
          <th class="px-4 py-2 border">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for note in notifications %}
        <tr
          class="hover:bg-green-50 transition {% if not note.is_read %}font-bold{% endif %}"
        >
          <td class="px-4 py-2 border text-center">{{ note.id }}</td>
          <td class="px-4 py-2 border font-semibold">{{ note.title }}</td>
          <td class="px-4 py-2 border">
            <div class="flex items-center gap-1 relative group">
              <span>{{ note.message|truncatechars:15 }}</span>
              <span class="cursor-pointer text-blue-600 hover:text-blue-800"
                >‚ÑπÔ∏è</span
              >
              <div
                class="fixed hidden group-hover:block bg-gray-900 text-white text-xs rounded-lg px-3 py-2 max-w-sm max-h-60 overflow-y-auto whitespace-normal shadow-lg z-[9999]"
                style="top: auto; left: auto"
              >
                {{ note.message }}
              </div>
            </div>
          </td>
          <td class="px-4 py-2 border">
            {{ note.created_at|date:"M d, Y H:i" }}
          </td>
          <td class="px-4 py-2 border text-center status-cell">
            {% if note.is_read %} ‚úÖ Read {% else %} üîπ Unread {% endif %}
          </td>
          <td class="px-4 py-2 border text-center">
            {% if not note.is_read %}
            <button
              class="mark-read-btn bg-green-600 hover:bg-green-800 text-white px-3 py-1 rounded-lg text-sm"
              data-id="{{ note.id }}"
            >
              Mark as Read
            </button>
            {% else %}
            <span class="text-gray-400">‚úîÔ∏è</span>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center py-6 text-green-700">
            No notifications available.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".mark-read-btn").forEach((button) => {
      button.addEventListener("click", async () => {
        const notificationId = button.dataset.id;

        try {
          const res = await fetch(
            `/notifications/mark-read/${notificationId}/`,
            {
              method: "GET",
              headers: { "X-Requested-With": "XMLHttpRequest" },
            }
          );
          const data = await res.json();

          if (data.status === "success") {
            const row = button.closest("tr");
            row.classList.remove("font-bold");
            row.querySelector(".status-cell").textContent = "‚úÖ Read";
            button.replaceWith("‚úîÔ∏è");
          }
        } catch (err) {
          console.error("Error marking notification as read", err);
        }
      });
    });
  });
</script>

{% endblock %}
